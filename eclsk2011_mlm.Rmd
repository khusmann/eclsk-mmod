---
title: "ECLS-K Growth Model"
author: "Kyle Husmann"
date: "September 27, 2019"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(lmerTest)
library(broom.mixed)
library(kableExtra)

data(eclsk2011)

df <- eclsk2011$study1 %>%
      filter(split == 'val') %>%
      filter_at(vars(TWORKS, TPERSIS, TSHOWS, TADAPTS, TKEEPS, TATTEN,
                            TBGCCLR, TBGCBLD, TBABSBK, TBEZDSL, TBTRBST, TBEZDAC, TBNOFIN,
                            TBSTNO, TBWTTSK, TFOLLOW, TBFLWIN), all_vars(!is.na(.))) %>%
      mutate(
        TFOLLOW_sc = TFOLLOW/4*7,
        TATTEN_sc = TATTEN/4*7
      ) %>%
      mutate(
         OATL_F1 = rowMeans(cbind(TWORKS, TPERSIS, TSHOWS, TADAPTS, TKEEPS), na.rm=T),
         OENG_F2 = rowMeans(cbind(TBGCCLR, TBGCBLD, TBABSBK), na.rm=T),
         OINHIB_F3 = rowMeans(cbind(TBSTNO, 8-TBTRBST, TFOLLOW_sc, TBWTTSK, 8-TBEZDSL,
                                 TBFLWIN, 8-TBEZDAC, TATTEN_sc, 8-TBNOFIN), na.rm=T)
      ) %>%
      mutate(
        MATL_F1 = rowMeans(cbind(TWORKS, TPERSIS, TSHOWS, TADAPTS, TKEEPS, TATTEN), na.rm=T),
        MENG_F2 = rowMeans(cbind(TBGCCLR, TBGCBLD, TBABSBK), na.rm=T),
        MINHIB_F3 = rowMeans(cbind(TBSTNO, TBWTTSK, TFOLLOW_sc, TBFLWIN), na.rm=T),
        MATTEN_F4 = rowMeans(cbind(8-TBEZDSL, 8-TBTRBST, 8-TBEZDAC, 8-TBNOFIN), na.rm=T)
      ) %>%
      mutate(
         PATL_F1 = rowMeans(cbind(TWORKS, TSHOWS, TPERSIS, TADAPTS, TATTEN, TKEEPS), na.rm=T),
         PENG_F2 = rowMeans(cbind(TBGCCLR, TBGCBLD, TBABSBK), na.rm=T),
         PINHIB_F3 = rowMeans(cbind(TBSTNO, TBWTTSK, TFOLLOW_sc, TBFLWIN), na.rm=T),
         PATTEN_F4 = rowMeans(cbind(8-TBEZDAC, 8-TBNOFIN), na.rm=T),
         PATTEN2_F5 = rowMeans(cbind(8-TBEZDSL, 8-TBTRBST), na.rm=T)
      ) %>%
      mutate(
        XTCHAPP_F1 = rowMeans(cbind(TWORKS, TPERSIS, TSHOWS, TADAPTS,
                                  TKEEPS, TATTEN, TFOLLOW), na.rm=T),
        XATTNFS_F4 = rowMeans(cbind(8-TBEZDAC, 8-TBNOFIN, 8-TBEZDSL,
                                  TBGCBLD, TBGCCLR, TBABSBK), na.rm=T),
        XINBCNT_F3 = rowMeans(cbind(8-TBTRBST, TBSTNO, TBWTTSK,
                                  TBFLWIN, TBPLNAC, TBAPRRK), na.rm=T))
```

```{r}
df %>%
select(XATTNFS, XATTNFS_F4, TBEZDAC, TBNOFIN, TBEZDSL,
       TBGCBLD, TBGCCLR, TBABSBK) %>% 
filter(is.na(df$XATTNFS_F4) != is.na(df$XATTNFS))
```
```{r}
(sum(abs(df$XTCHAPP_F1 - df$XTCHAPP)>0.01, na.rm=T))
(sum(abs(df$XATTNFS_F4 - df$XATTNFS)>0.01, na.rm=T))
(sum(abs(df$XINBCNT_F3 - df$XINBCNT)>0.01, na.rm=T))

(sum(is.na(df$XTCHAPP_F1) != is.na(df$XTCHAPP)))
(sum(is.na(df$XATTNFS_F4) != is.na(df$XATTNFS)))
(sum(is.na(df$XINBCNT_F3) != is.na(df$XINBCNT)))

```
# Make models

```{r}
models_read <- list(
  theory = lmer(XRSCALK4 ~ grade + XATTNFS_F4 + XTCHAPP_F1 + XINBCNT_F3 + (1+grade|CHILDID), df,
             REML=F, control=lmerControl(optimizer='bobyqa')),
  
  f3 = lmer(XRSCALK4 ~ grade + OATL_F1 + OENG_F2 + OINHIB_F3 + (1+grade|CHILDID), df,
            REML=F, control=lmerControl(optimizer='bobyqa')),
  
  f4 = lmer(XRSCALK4 ~ grade + MATL_F1 + MENG_F2 + MINHIB_F3 + MATTEN_F4 + (1+grade|CHILDID), df,
             REML=F, control=lmerControl(optimizer='bobyqa')),
  
  f5 = lmer(XRSCALK4 ~ grade + PATL_F1 + PENG_F2 + PINHIB_F3 + PATTEN_F4 + PATTEN2_F5 + (1+grade|CHILDID), df,
             REML=F, control=lmerControl(optimizer='bobyqa'))
)

models_math <- list(
  theory = lmer(XMSCALK4 ~ grade + XATTNFS_F4 + XTCHAPP_F1 + XINBCNT_F3 + (1+grade|CHILDID), df,
             REML=F, control=lmerControl(optimizer='bobyqa')),
  
  f3 = lmer(XMSCALK4 ~ grade + OATL_F1 + OENG_F2 + OINHIB_F3 + (1+grade|CHILDID), df,
            REML=F, control=lmerControl(optimizer='bobyqa')),
  
  f4 = lmer(XMSCALK4 ~ grade + MATL_F1 + MENG_F2 + MINHIB_F3 + MATTEN_F4 + (1+grade|CHILDID), df,
             REML=F, control=lmerControl(optimizer='bobyqa')),
  
  f5 = lmer(XMSCALK4 ~ grade + PATL_F1 + PENG_F2 + PINHIB_F3 + PATTEN_F4 + PATTEN2_F5 + (1+grade|CHILDID), df,
             REML=F, control=lmerControl(optimizer='bobyqa')) 
)
```

```{r}
models <- tibble(
  type = c('read', 'math'),
  model = list(models_read, models_math),
  struct = map(model, names)
) %>%
  unnest(c(model, struct)) %>%
  mutate(id = str_c(type, struct, sep='.'),
         summary = map(model, summary),
         tdy = map(model, tidy, conf.int=T, conf.method='Wald', quiet=T),
         glnc = map(model, glance))

models_summary <- models$summary %>%
  set_names(models$id)

(results <- models %>%
  select(type, struct) %>%
  bind_cols(map_dfr(map(models$summary, 'AICtab'), as.list)))
```

```{r}
isSignificant = function(lo, hi) {(lo > 0 & hi > 0) | (lo < 0 & hi < 0)}
format_estimate <- function(tbl) {
  if (nrow(tbl) == 0) {
    '-'
  } else {
    sig = isSignificant(tbl[['conf.low']], tbl[['conf.high']])
    if (is.na(sig)) {
      sprintf('%0.2f', tbl[['estimate']])
    } else {
      sprintf('%0.2f%s [%0.2f, %0.2f]', tbl[['estimate']],
              if_else(isSignificant(tbl[['conf.low']], tbl[['conf.high']]), '*', ''),
              tbl[['conf.low']], tbl[['conf.high']])
    }
  }
}
table_col <- function(mod) {
  tidy_mod <- tidy(mod, conf.int=T, conf.method='Wald', quiet=T)
  glance_mod <- glance(mod)
  
  mappings <- c(
    `(Intercept)` = '^\\(Intercept\\)',
    `Grade` = '^grade',
    `Approaches to Learning` = '.*F1',
    `Engagement` = '.*F2',
    `Inhibitory Control` = '.*F3',
    `Attentional Focusing` = '.*F4',
    `Attentional Focusing (2)` = '.*F5',
    `sd(Intercept)` = 'sd__\\(Intercept\\)',
    `cor(Intercept, grade)` = 'cor__\\(Intercept_grade\\)',
    `sd(grade)` = 'sd__grade',
    `sd(resid)` = 'sd__Observation'
  )
  c(
     map(mappings, function(i) {
      tidy_mod %>%
        filter(str_detect(term, i)) %>%
        format_estimate()
    }),
    `-2LL` = sprintf('%0.0f', glance_mod[['logLik']]),
    `df.residual` = sprintf('%d', glance_mod[['df.residual']]),
    `AIC` = sprintf('%0.0f', glance_mod[['AIC']]),
    `BIC` = sprintf('%0.0f', glance_mod[['BIC']])   
  )
}

models %>%
  select(id) %>%
  arrange(id) %>%
  bind_cols(map_dfr(models$model, table_col)) %>%
  pivot_longer(-id, names_to='term', values_to='estimate') %>%
  pivot_wider(names_from=id, values_from=estimate) %>%
  set_names(c(' ', rep(c('Theory', '3 Factor', '4 Factor', '5 Factor'), 2))) %>%
  kable(booktabs=T, align=c('l', 'c'), escape=F) %>%
  kable_styling(latex_options = c('scale_down')) %>%
  add_header_above(c(' ' = 1,
                     'Reading' = 4,
                     'Math' = 4)) %>%
  group_rows(index=c('Fixed Effects' = 7,
                     'Random Effects' = 4,
                     'Model Fit' = 4))
  
```

```{r}
models_summary$read.f4
models_summary$read.theory
```

```{r}
models_summary$math.f4
models_summary$math.theory
```

```{r}
#subset <- sample(unique(df$CHILDID), 40)
subset <- unique(df$CHILDID)

df %>%
  filter(CHILDID %in% subset) %>%
  ggplot(aes(x=grade, y=XMSCALK4, group=CHILDID)) +
  geom_line(alpha=0.9995^(length(subset)))

```

```{r, fig.height=21, fig.width=6}
df %>%
  gather(var, val, XMSCALK4, XRSCALK4, MATL_F1, MENG_F2, MINHIB_F3, MATTEN_F4, XATTNFS_F4, XTCHAPP_F1, XINBCNT_F3) %>%
  ggplot(aes(val)) +
  geom_histogram() +
  facet_wrap(var~grade, scales='free_x', ncol=3)
```
