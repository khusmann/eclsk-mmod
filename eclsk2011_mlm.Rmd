---
title: "ECLS-K Growth Model"
author: "Kyle Husmann"
date: "September 27, 2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(lavaan)
library(lmerTest)

data(eclsk2011)

df <- eclsk2011$study1 %>%
      filter(split == 'val') %>%
      mutate(
        # TODO: is this ok?
        TFOLLOW_sc = TFOLLOW/4*7,
        MATL = rowMeans(cbind(TWORKS, TPERSIS, TSHOWS, TADAPTS, TKEEPS, TATTEN), na.rm=T),
        MFLOW = rowMeans(cbind(TBGCCLR, TBGCBLD, TBABSBK), na.rm=T),
        MDIST = rowMeans(cbind(TBEZDSL, TBTRBST, TBEZDAC, TBNOFIN), na.rm=T),
        MINHIB = rowMeans(cbind(TBSTNO, TBWTTSK, TFOLLOW_sc, TBFLWIN), na.rm=T)
      ) 
      

```

```{r}
mod1 <- lmer(XRSCALK4 ~ MDIST + MFLOW + MATL + MINHIB + grade + (1+grade|CHILDID), df,
             REML=F, control=lmerControl(optimizer='bobyqa'))
mod2 <- lmer(XRSCALK4 ~ XATTNFS + XTCHAPP + XINBCNT + grade + (1+grade|CHILDID), df,
             REML=F, control=lmerControl(optimizer='bobyqa'))
summary(mod1)
summary(mod2)
```

```{r}
mod1 <- lmer(XMSCALK4 ~ MDIST + MFLOW + MATL + MINHIB + grade + (1+grade|CHILDID), df,
             REML=F, control=lmerControl(optimizer='bobyqa'))
mod2 <- lmer(XMSCALK4 ~ XATTNFS + XTCHAPP + XINBCNT + grade + (1+grade|CHILDID), df,
             REML=F, control=lmerControl(optimizer='bobyqa'))
summary(mod1)
summary(mod2)
```


```{r}
#subset <- sample(unique(df$CHILDID), 40)
subset <- unique(df$CHILDID)

df %>%
  filter(CHILDID %in% subset) %>%
  ggplot(aes(x=grade, y=XMSCALK4, group=CHILDID)) +
  geom_line(alpha=0.9995^(length(subset)))

```

```{r, fig.height=21, fig.width=6}
df %>%
  gather(var, val, XMSCALK4, XRSCALK4, MDIST, MFLOW, MATL, MINHIB, XATTNFS, XTCHAPP, XINBCNT) %>%
  ggplot(aes(val)) +
  geom_histogram() +
  facet_wrap(var~grade, scales='free_x', ncol=3)

```
