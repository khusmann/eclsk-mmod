---
title: "Measurement models for executive function"
author: "Kyle Husmann"
date: "March 25, 2019"
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(psych)

data(eclsk2011)

filter_occasion <- function(data, o) {
  data %>%
    filter(occasion == o) %>%
    select(-occasion) %>%
    na.omit()
}

do_parallel <- function(data, occasion) {
  data %>%
    filter_occasion(occasion) %>%
    fa.parallel()
}

do_explore <- function(data, occasion, nfactors) {
  data %>%
    filter_occasion(occasion) %>%
    fa(nfactors, rotate='promax')
}
```

# Study 1

```{r}
study1_measures <- c('TKEEPS', 'TSHOWS', 'TWORKS', 'TADAPTS', 'TFOLLOW', 'TPERSIS', 'TATTEN',
                     'TBEZDAC', 'TBNOFIN', 'TBGCCLR', 'TBGCBLD', 'TBEZDSL', 'TBABSBK',
                     'TBWTTSK', 'TBTRBST', 'TBFLWIN', 'TBSTNO') # Omit: 'TBPLNAC', 'TBAPRRK'

study1_data <- eclsk2011$study1 %>%
               filter(split == 'train') %>%
               select(c('occasion', study1_measures))

study1_occasions <- c(1,2,4)
```

```{r}
study1_parallel <- study1_occasions %>%
                   map(~do_parallel(study1_data, .))
```

```{r}
study1_fa <- expand_grid(nfactors = c(2,3,4,5),
                         occasion = study1_occasions) %>%
             mutate(fa_result = pmap(., do_explore, study1_data))

pwalk(study1_fa, function(occasion, nfactors, fa_result) {
  fa.diagram(fa_result, main=paste0('Occasion: ', occasion, ', nF: ', nfactors), cut=0.2)
})
```

# Study 2

```{r}
study2_measures <- c('TKEEPS', 'TSHOWS', 'TWORKS', 'TADAPTS', 'TFOLLOW', 'TPERSIS', 'TATTEN',
                   'TBEZDSL', 'TBSPTLD', 'TBLKARO', 'TBSPQIK', 'TBEZDAC', 'TBEZWAT', 'TBHTATN',
                   'TBHTTLK', 'TBPYATN', 'TBDSATN', 'TBPLANS', 'TBFLWIN', 'TBHTSLW')

study2_data <- eclsk2011$study2 %>%
               filter(split == 'train') %>%
               select(c('occasion', study2_measures))

study2_occasions <- c(6,7,8)
```

```{r}
study2_parallel <- study2_occasions %>%
                   map(~do_parallel(study2_data, .))
```


```{r}
study2_fa <- expand_grid(nfactors = c(2,3,4,5),
                         occasion = study2_occasions) %>%
             mutate(fa_result = pmap(., do_explore, study2_data))

pwalk(study2_fa, function(occasion, nfactors, fa_result) {
  fa.diagram(fa_result, main=paste0('Occasion: ', occasion, ', nF: ', nfactors))
})
```