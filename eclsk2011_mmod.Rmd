---
title: "Measurement models for executive function"
author: "Kyle Husmann"
date: "March 25, 2019"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(kableExtra)

mmod_models <- function(studyname) {
  mmod_models <- Sys.glob(paste0('data/res/', studyname, '/*_model.rds')) %>%
                 map(read_rds) %>%
                 map(rlang::eval_tidy)
  names(mmod_models) <- map(mmod_models, 'name')
  mmod_models
}

mmod_results <- function(studyname) {
  mmod_results <- Sys.glob(paste0('data/res/', studyname, '/*_result.rds')) %>%
                  map(read_rds)
  names(mmod_results) <- map(mmod_results, 'modelName')
  mmod_results
}

mmod_fits <- function(mmod_results) {
  tibble(
    name=map_chr(mmod_results, 'modelName'),
    n=map_dbl(mmod_results, 'numObs'),
    chisq=map_dbl(mmod_results, 'Chi'),
    dof=map_dbl(mmod_results, 'ChiDoF'),
    `-2ll`=map_dbl(mmod_results, 'Minus2LogLikelihood'),
    aic=map_dbl(mmod_results, 'AIC.Mx'),
    bic=map_dbl(mmod_results, 'BIC.Mx'),
    rmsea=map_dbl(mmod_results, 'RMSEA'),
    cfi=map_dbl(mmod_results, 'CFI'),
    tli=map_dbl(mmod_results, 'TLI')
  )
}
```

```{r}
study1_models <- mmod_models('eclsk2011_study1')
study2_models <- mmod_models('eclsk2011_study2')
```

```{r}
study1_results <- mmod_results('eclsk2011_study1')
(study1_fits <- mmod_fits(study1_results))
```

```{r}
study2_results <- mmod_results('eclsk2011_study2')
(study2_fits <- mmod_fits(study2_results))
```

```{r}
measures_theory <- list(
  ATL = c('TKEEPS', 'TSHOWS', 'TWORKS', 'TADAPTS', 'TFOLLOW', 'TPERSIS', 'TATTEN'),
  CBQ_A = c('TBEZDAC', 'TBNOFIN', 'TBGCCLR', 'TBGCBLD', 'TBEZDSL', 'TBABSBK'),
  CBQ_I = c('TBWTTSK', 'TBTRBST', 'TBFLWIN', 'TBSTNO') # Omitting: 'TBPLNAC', 'TBAPRRK'
# Parent Items
    # ATL_P = c('PWRKFIN', 'PSHWINT', 'PCONCEN', 'PCHORES', 'PLEARN', 'PCREATV'),
# Child assessment
    # DCCS = c('XCSBGSC')
    # NREV = c('XNRSSCR')
)
```

```{r}
#mmod_theory <- mmodModel(measures_theory, 'theory', fiml=F)
#mmod_theory_res <- mxRun(mmod_theory)
#summary(mmod_theory_res)
```

```{r}
#cfa_theory <- map(occasions, ~cfaModel(measures_theory, paste0('theorycfa', .), ., fiml=T))
#names(cfa_theory) <- map(cfa_theory, 'name')
#cfa_theory_res <- map(cfa_theory, mxRun)
#map(cfa_theory_res, summary)
```